<html>
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>

	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.0/themes/smoothness/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.js"></script>

	<link rel="stylesheet" type="text/css" href="css/style.css">
	<title>Service Logs</title>
</head>
<body id="serviceLogs">

<div id="leftMenu" style="display:none">
{{#each cars}}
<div class="car" id="carId{{id}}">
	<a href="logs?carId={{id}}">{{name}}</a>
</div>
{{/each}}
</div>

<div id="mainBody">
<div class="header" style="float:left">
<div class="back"><img src="/images/arrow-back.png"/ id="leftMenuButton"></div>
<div class="title">{{car.name}}</div>
</div>
<form id="maintenance" action="#">
	<input name="carId" type="hidden" value="{{car.id}}"/>
<table>
<thead>
<tr>
<th class="date">Date</th>
<th class="mileage">Mileage</th>
<th class="service">Service</th>
<th class="cost">Cost</th>
<th class="notes">Notes</td>
<th></th>
<tr>
<td class="date"><input id="gridFriendlyDate" class="date" type="text"/><input id="gridServiceDate" name="serviceDate" type="hidden"/></td>
<td class="mileage"><input id="gridMileage" name="mileage" class="mileage" type="text"/></td>
<td class="service"><input id="gridService" name="service" class="service" type="text"/></td>
<td class="cost"><input id="gridCost" name="cost" class="cost" type="text"/></td>
<td class="notes"><input id="gridNote" name="note" class="notes" type="text"/><input type="submit" style="display:none"/></td>
<td></td>
</tr>
</thead>
<tbody>
{{#each logs}}
<tr data="{{service}}">
<td class="date">{{formatDate performed_on "MMMM DD, YYYY"}}</td>
<td class="mileage">{{mileage}}</td>
<td class="service">{{service}}</td>
<td class="cost">{{cost}}</td>
<td class="notes">{{note}}</td>
<td class="actions"><a href="#maintenanceId={{id}}">E</a></td>
</tr>
{{/each}}
</tbody>
<tfoot>
<tr class="pendingSave" style="display:none">
<td class="date"></td>
<td class="mileage"></td>
<td class="service"></td>
<td class="cost"></td>
<td class="notes"></td>
<td></td>
</tr>
</tfoot>
</table>
</form>
</div>

<div id="editLogDialog">
	<form id="editMaintenance" action="#">
		<input id="editId" name="id" type="hidden"/>
		<label>Date:</label><input id="editDate" name="date" class="date" type="text"/><br/>
		<label>Mileage:</label><input id="editMileage" name="mileage" class="mileage" type="text"/><br/>
		<label>Service:</label><input id="editService" name="service" class="service" type="text"/><br/>
		<label>Cost:</label><input id="editCost" name="cost" class="cost" type="text"/><br/>
		<label>Note:</label><input id="editNote" name="note" class="note" type="text"/>
	</form>
</div>

<script>

$( document ).ready(function() {

	//extracts all service from the log
	var allServices = $( "table tbody tr" ).map(function() {
    	return $(this).attr("data");
  	}).get();

	AUOTCOMPLETE.setup('#gridService', FILTERS.FILTER_CONTAINS, allServices);
	AUOTCOMPLETE.setup('#gridFriendlyDate', FILTERS.FILTER_STARTWITH, DATEUTILS.months);
	TABLEFILTER.setup('#gridService', FILTERS.FILTER_CONTAINS);
	MAINTENANCELOG.setup();

	$('#leftMenuButton').on('click', function(e){
		$('#leftMenu').toggle();
	});

	$("#gridMileage").focus();

}); 

var MAINTENANCELOG = {
	setup: function(){

		$("#maintenance").submit(function(e) {
			if (MAINTENANCELOG.validate()){
				MAINTENANCELOG.addLog();
			}

			e.preventDefault();
		});	

		//initialize editDialog
		$( "#editLogDialog" ).dialog({
            autoOpen: false, title: "Edit", modal: true,
            buttons: {
                OK: function() {
                	$(this).dialog("close");
        			var params = $('#editMaintenance').serialize();
					$.ajax({
					  url: '/api/updateLog',
					  data: params,
					  success: function(data, status) {
					  	console.log("Updated maintenance log");
					  }
					});

                }
            }

        });

        //support for editing record
		$("table tbody .actions A").on("click", function(e) {
            $( "#editLogDialog" ).dialog( "open" );

			var hashParam = UTILS.hashParam(e.currentTarget['href']);
			$.ajax({
			  url: '/api/editLog',
			  data: { maintenanceId: hashParam['maintenanceId'] },
			  success: function(data, status) {
				$("#editId").val(data[0].id);
				$("#editMileage").val(data[0].mileage);
				$("#editService").val(data[0].service);
				$("#editNote").val(data[0].note);
				$("#editCost").val(data[0].cost);
			  }
			});
		});

		//add todays date as placeholder
		$('#gridFriendlyDate').attr("placeholder", DATEUTILS.format(new Date()));

	},
	validate: function(){
		var serviceDate = $("#gridFriendlyDate").val(),
			isValidForm = true;

		if (serviceDate.length===0){
			serviceDate = $("#gridFriendlyDate").attr("placeholder");
			$("#gridFriendlyDate").val(serviceDate);
		} else {
			if (!DATEUTILS.isValid(serviceDate)) {
			 	$("#gridFriendlyDate").addClass("error");
			 	isValidForm = false;
			 }
		}


		var mileage = $("#gridMileage").val();
		if (!$.isNumeric(mileage)) {
			 	$("#gridMileage").addClass("error");
			 	isValidForm = false;
		} else {
	 		$("#gridMileage").removeClass("error");
	 	}

		var service = $("#gridService").val();
		if (service.length===0){
		 	$("#gridService").addClass("error");
		 	isValidForm = false;
		} else {
		 	$("#gridService").removeClass("error");
		}

		return isValidForm;
	},
	addLog: function() {
		var newRow = $("table tfoot tr").clone();
		newRow.find(".date").html($("#gridFriendlyDate").val());
		newRow.find(".mileage").html($("#gridMileage").val());
		newRow.find(".service").html($("#gridService").val());
		newRow.find(".cost").html($("#gridCost").val());
		newRow.find(".notes").html($("#gridNote").val());
		newRow.attr("data","service");
		newRow.insertBefore("table tbody tr:nth-child(1)");
		
		//convert date
		var sqlDate = DATEUTILS.sql(new Date($("#gridFriendlyDate").val()));
		$("#gridServiceDate").val(sqlDate);

		var params = $('#maintenance').serialize();
		$.ajax({
		  url: '/api/addLog',
		  data: params,
		  success: function(data, status) {
		  	newRow.removeClass("pendingSave");
		  }
		});

		TABLEFILTER.clear();
		AUOTCOMPLETE.clear($("#gridService"));
		$("#gridCost").val("");
		$("#gridService").val("");
		$("#gridService").focus();
		
	}
}

var DATEUTILS = {
	regex: /^(January|February|March|April|May|June|July|August|September|November|December)\s\d{1,2},\s20\d\d$/i,
	format: function(d){
		return this.months[d.getMonth()] + " " + d.getDate() + ", " + d.getFullYear();
	},
	sql: function(d){
		return d.getFullYear() + "-" + (d.getMonth()+1) + "-" + d.getDate();
	},
	isValid: function(s) {
		return !(s.match(DATEUTILS.regex) === null);
	},
	months: ["January","February","March","April","May","June","July","August","September","November","December"]
}

var FILTERS = {
	FILTER_STARTWITH: function(row, criteria){
		return row.startsWith(criteria);
	},

 	FILTER_CONTAINS: function(row, criteria){
		return row.contains(criteria);
	}
};

var TABLEFILTER = {
	setup: function(selector, filter) {
	$(selector).on('keypress', function(e){
		TABLEFILTER.filter($(this).data("inlineauto"), filter);
	});
	},
	filter: function (criteria, filter) {
		console.log("Filter: " + criteria);
			$("table tbody tr").each(function( index ) {
				if (filter($(this).attr("data"), criteria)) //.search(criteria)==-1)
					$(this).show();
				else 
					$(this).hide();
			});
	},
	clear: function(){
		$("table tbody tr").show();
	}

};

var AUOTCOMPLETE = {
	setup: function(selector, filter, allValues) {
		$(selector).on('keypress', function(e){
			if (AUOTCOMPLETE.doComplete($(this), e.which, allValues, filter))
	        	e.preventDefault();
		});
		$(selector).on('keydown', function(e){
			if (e.which === 8){
				$(this).data("reset","true");
			}
		});
	},
	doComplete: function (inputField, keyChar, allValues, filter){
			var key = String.fromCharCode(keyChar),
	        	criteria;

			if (keyChar === 13){
				return false;
			}

	        if (inputField.data("reset")) {
	        	inputField.removeData("reset");
	        	inputField.data("inlineauto", inputField.val());
	        }

			//set value on space
	        if (keyChar === 32) {
		        inputField.data("inlineauto",inputField.val() + " ");
		        return false;
	        }

	        //append current key to autocomplete
	        if (inputField.data("inlineauto")){
		        criteria = inputField.data("inlineauto") + key;
		    } else {
		    	criteria = key;
		    }
	        //save current autocomplete value
		    inputField.data("inlineauto",criteria);

	        console.log("Autocomplete: " + criteria);

	        //find matching values
	        var matched = jQuery.grep(allValues, function( n, i ){
	        	return filter(n,criteria);
	        });

	        //if no match set value to current autocomplete
	        if (matched.length==0) {
	        	if (inputField.data("reset")){
	        		inputField.val(inputField.val() + key);
	        		inputField.removeData("reset");
	        	} else {
	        		inputField.val(criteria);
	        	}
	    	} else {
	        	inputField.val(matched[0]);
	        }

		    return true;
	},
	clear: function(inputField){
		inputField.val("");
		inputField.removeData("inlineauto");
	}

};

var UTILS = {
	hashParam: function(link){
		var hash = link.substring(link.indexOf('#')+1);
    	var params = hash.split('&');
    	var result = {};
    	for(var i = 0; i < params.length; i++){
       		var propval = params[i].split('=');
       		result[propval[0]] = propval[1];
       	}

       	return result;
	}
}


String.prototype.contains = function(it) { return this.indexOf(it) != -1; };
</script>
</body>
</html>
